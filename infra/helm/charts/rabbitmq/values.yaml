# RabbitMQ Helm Values for CotAI Platform
# Based on Bitnami RabbitMQ chart

replicaCount: 3

image:
  registry: docker.io
  repository: bitnami/rabbitmq
  tag: 3.12.10
  pullPolicy: IfNotPresent

auth:
  username: cotai_admin
  # Password should be stored in external secrets
  existingPasswordSecret: rabbitmq-credentials
  existingSecretPasswordKey: password
  erlangCookie: CHANGEME_ERLANG_COOKIE # Should be stored in secrets

clustering:
  enabled: true
  addressType: hostname
  rebalance: true

persistence:
  enabled: true
  storageClass: "gp3"
  accessMode: ReadWriteOnce
  size: 20Gi

resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 1000m
    memory: 2Gi

# High Availability
podDisruptionBudget:
  create: true
  minAvailable: 2

# Affinity for multi-AZ distribution
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
    - labelSelector:
        matchExpressions:
        - key: app.kubernetes.io/name
          operator: In
          values:
          - rabbitmq
      topologyKey: topology.kubernetes.io/zone

# Monitoring
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: cotai-observability
    interval: 30s

# Probes
livenessProbe:
  enabled: true
  initialDelaySeconds: 120
  periodSeconds: 30
  timeoutSeconds: 20
  failureThreshold: 6
  successThreshold: 1

readinessProbe:
  enabled: true
  initialDelaySeconds: 10
  periodSeconds: 30
  timeoutSeconds: 20
  failureThreshold: 3
  successThreshold: 1

# Load balancer configuration
service:
  type: ClusterIP
  port: 5672
  tlsPort: 5671
  managerPort: 15672

# RabbitMQ configuration
configuration: |-
  ## Queue master locator
  queue_master_locator = min-masters
  ## Enable autocluster
  cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s
  cluster_formation.k8s.host = kubernetes.default.svc.cluster.local
  cluster_formation.k8s.address_type = hostname
  ## Memory and disk thresholds
  vm_memory_high_watermark.relative = 0.6
  disk_free_limit.absolute = 2GB
  ## Network configuration
  heartbeat = 60
  ## Message TTL and limits for CotAI
  default_vhost = cotai
  default_user = cotai_admin
  default_permissions.configure = .*
  default_permissions.read = .*
  default_permissions.write = .*

# Policies and definitions
loadDefinition:
  enabled: true
  existingSecret: rabbitmq-load-definition

# Extra environment variables
extraEnvVars:
  - name: RABBITMQ_LOGS
    value: "-"
  - name: RABBITMQ_LOG_LEVEL
    value: "info"

# Node selector for production nodes
nodeSelector:
  role: general
  environment: production
